<% payment_trace_id ||= article.payment_trace_id current_user %>
<% payment_amount ||= article.buy_payment_amount pay_asset_id %>
<% payment_url ||= article.buy_url(current_user, pay_asset_id) %>
<% payment = Payment.find_by(trace_id: payment_trace_id) %>
<% currency = Currency.find_by(asset_id: pay_asset_id) %>

<div id="payment_<%= payment_trace_id %>">
  <div data-article-paymnent-target="price" class="flex items-center justify-center space-x-2 text-base">
    <span class="text-red-500 font-bold "><%= "#{format('%.8f', payment_amount)}" %></span>
    <span><%= currency_symbol %></span>
  </div>

  <div data-buy-article-payment-target="state" 
       class="mb-4 <%= payment.blank? ? 'hidden' : '' %>">
    <%= render partial: "shared/loading" %>
    <div class="text-sm text-center opacity-70">
      <%= payment.blank? ? t('waiting_for_payment') : t('processing_your_payment') %>
    </div>
  </div>

  <% if current_user.fennec? %>
    <a data-controller="fennec"
      data-action="fennec#pay"
      data-fennec-trace-id-param="<%= payment_trace_id %>"
      data-fennec-asset-id-param="<%= pay_asset_id %>"
      data-fennec-amount-param="<%= payment_amount %>"
      data-fennec-memo-param="<%= article.buy_payment_memo %>"
      data-fennec-opponent-id-param="<%= current_user&.wallet_id || article.wallet_id %>"
      class="flex justify-center items-center space-x-2 w-full my-4 text-center no-underline cursor-pointer py-2 block bg-amber-600 hover:bg-amber-700 active:bg-amber-500 text-white rounded">
      <%= image_tag 'fennec-logo.png', class: 'h-6 w-auto' %>
      <span><%= t('pay_with_fennec') %></span>
    </a>
  <% elsif current_user.mvm_eth? %>
    <button data-controller="metamask"
      data-action="metamask#pay"
      data-metamask-contract-param="<%= current_user.authorization.contract %>"
      data-metamask-trace-id-param="<%= payment_trace_id %>"
      data-metamask-asset-id-param="<%= pay_asset_id %>"
      data-metamask-symbol-param="<%= currency.symbol %>"
      data-metamask-icon-url-param="<%= currency.icon_url %>"
      data-metamask-amount-param="<%= payment_amount %>"
      data-metamask-memo-param="<%= article.buy_payment_memo %>"
      data-metamask-opponent-id-param="<%= current_user&.wallet_id || article.wallet_id %>"
      class="flex justify-center items-center space-x-2 w-full mt-4 mb-2 text-center no-underline cursor-pointer py-2 block bg-stone-600 hover:bg-stone-700 active:bg-stone-500 text-white rounded">
      <%= image_tag 'https://docs.metamask.io/metamask-fox.svg', class: 'h-6 w-auto' %>
      <template data-metamask-target="waiting">
        <div>
          <%= render partial: "shared/loading" %>
          <div class="text-sm text-center opacity-70">
            <%= t('waiting_for_payment') %>
          </div>
        </div>
      </template>
      <span><%= t('pay_with_metamask') %></span>
    </button>

    <%= button_to view_modals_path(type: :mvm_deposit), 
      class: "flex justify-center items-center space-x-2 w-full mt-4 mb-2 text-center no-underline cursor-pointer py-2 block bg-indigo-900 hover:bg-indigo-800 active:bg-indigo-700 text-white rounded" do %>
      <%= image_tag 'https://mvm.dev/logo.svg', class: 'h-6 w-auto' %>
      <div><%= t('deposit_to_mvm') %></div>
    <% end %>
  <% else %>
    <% unless from_mixin_messenger? %>
      <div data-controller="qrcode" 
          data-qrcode-url-value="<%= payment_url %>">
          <div data-qrcode-target="placeholder" class="flex justify-center"></div>
          <div class="text-center py-2 text-gray-500 text-sm">
            <%= t("scan_with_mixin") %>
          </div>
      </div>
    <% end %>

    <a href="<%= payment_url %>"
      data-buy-article-payment-target="payButton"
      data-action="click->buy-article-payment#invokePayment"
      class="w-full my-4 text-center no-underline cursor-pointer py-2 block bg-blue-500 hover:bg-blue-600 active:bg-blue-500 text-white rounded md:hidden">
      <%= t('pay_with_mixin') %>
    </a>
  <% end %>
</div>
